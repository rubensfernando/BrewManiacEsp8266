# Audio prompt during brewing

The web interface can play audio to prompt progress of brewing. "**sounds.json**" is needed to specify the audio segments.

## sounds.json format
sounds.json should be in JSON format. It looks like

```
{"src":"sounds.m4a",
"seg":{
"open":{"s":0,"t":2.2,"r":1},
"tr":{"s":2.3,"t":1.5,"r":1},
"addhop":{"s":4,"t":1.2,"r":3},
"addmalt":{"s":5.5,"t":1.4,"r":1},
"boil":{"s":7.1,"t":1.2,"r":1},
"boilend":{"s":8.6,"t":1.2,"r":1},
"bye":{"s":10,"t":2,"r":1},
"chill":{"s":12,"t":1.2,"r":3},
"cool":{"s":13.5,"t":1.2,"r":2},
"iodine":{"s":15,"t":2,"r":3},
"maltin":{"s":17,"t":1.4,"r":3},
"mashout":{"s":18.5,"t":1.4,"r":1},
"nmash":{"s":20,"t":2,"r":1},
"removemalt":{"s":22,"t":1.6,"r":3},
"whirlpool":{"s":24,"t":1.3,"r":2},
"disc":{"s":25.5,"t":1.6,"r":2}}
}
```

**src** sepcifies the source of actual audio files, usually a mp3 or m4a file. It doesn't have to be a local file. You might specify any URL given that host supports CORS.

Each voice segments is defined as
```
"<nametag>":{"s":<starting pos>, "t":<duration>,"r":<repeat>}
```

**<starting pos>** specifies the relative postion, in seconds, of the audio segment in the file, while **<duration>** specifies the duration of the audio segment. **<repeat>** specifies the times to repeat the audio segment.
**<nametag>** list
| tag | When | Example |
|---|---|---|
| open | Successfully connected | BrewManiac, at your service |
| tr | Setting temperature reached. | Temperature reached. |
| addhop | reminder of adding hop | Time to add hop |
| addmalt | reminder of adding malt | Time to add malt |
| boil | Boiling phase starts | start boiling |
| boilend | Finish boiling | boiling finished |
| bye | brew finished. | brew finished. goodbye. |
| chill | reminder of chilling for hopstand | start chilling |
| cool | start of cooling stage | time to cool |
| iodine | reminder of iodine test | Time for iodine test |
| maltin | temperature reaches mash-in temperature | ready to doughing-in |
| mashout | start of mashout | start mash out |
| nmash | proceed to next mash steop | continue to next mash step |
| removemalt | reminder of removing malt | Time to remove malt |
| whirlpool | reminder of whirlpool starts | time to whirlpool |
| disc | connection disconnected | Controller disconnected |


## Guideline/tips of audio files

- Keep the file as small as possible. It’s not a concert recording, so use lowest sampling rate.
- If your audio file are larger than 150k, putting it on the controller might not work. (This might be issues of ESPAsyncWebServer/ESPAsyncTcp. Keep it as a known issue.)
- There is a lag of playing audio on Safari. Having about 200~250ms silence before(including) and after(not including) the audio segment is necessary to make it work better on Safari. For example, if the audio segment is 1 seconds and will be appended at time 15 seconds, you should insert a silence of 0.2 second before the real audio, and another 0.2 second of silence after the audio segment. Then, mark the segment start at 15 second with 1.2 duration.
- OSX has text to speech built-in. You can type something like this to create a audio segment. 
```
>say -v "Samantha" "Hello, I am Siri."
```
    
To output the audio to a file, add “-o” option, like “-o siri”.
- [oceanaudio](http://www.ocenaudio.com) is very good for creating the audio file. You can use it to 
    - merge the audio segments
    - insert/delete silence space between segments
    - re-sample the audio to make it smaller
    - check the start and duration of the audio segment.


## Issues of Safari
There are two issues related Safari.
First, Safari doesn't automatically play audio. You will need to change the setting.  [Follow the instruction described here.](https://connection.nwea.org/s/article/Audio-does-not-play-automatically-in-Safari?language=en_US).

Second, Safari requests audio file in a special way that the web server used, ESPAsyncWebServer, doesn't support, which is "keeping connection alive". A workaround is place the audio file at other server.

## Example files
- sounds.m4a: example audio file generated by TTS engine of Mac.
- sounds.json: the json to be used with audio file above.
- sounds.github.json: The JSON file that use the audio file above directly.

If you don't use Safari, uploading sounds.m4a & sounds.json to BM via filemanager should do the job. For Safari users as well as all others, uploading the sounds.github.json to be sounds.json might work. Access to github.com is necessary since the audio file is accessed directly from here, on github.com 

